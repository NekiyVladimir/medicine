{% extends 'base.html' %}

{% block title %}Добавление новости{% endblock %}

{% block content %}
<style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .block-form {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #5cb85c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #4cae4c;
        }
        .hidden {
            display: none;
        }
    </style>
<!--    <script>
        function toggleBlockFields(selectElement) {
            const blockDiv = selectElement.closest('.block-form');
            const textField = blockDiv.querySelector('.text-field');
            const imageField = blockDiv.querySelector('.image-field');
            const videoField = blockDiv.querySelector('.video-field');

            // Скрытие всех полей
            textField.classList.add('hidden');
            imageField.classList.add('hidden');
            videoField.classList.add('hidden');

            // Отображение соответствующего поля в зависимости от выбора
            switch (selectElement.value) {
                case 'text':
                    textField.classList.remove('hidden');
                    break;
                case 'image':
                    imageField.classList.remove('hidden');
                    break;
                case 'video':
                    videoField.classList.remove('hidden');
                    break;
            }
        }

        function moveBlock(blockDiv, direction) {
            const sibling = direction === 'up' ? blockDiv.previousElementSibling : blockDiv.nextElementSibling;
            if (sibling) {
                const parent = blockDiv.parentNode;
                if (direction === 'up') {
                    parent.insertBefore(blockDiv, sibling);
                } else {
                    parent.insertBefore(sibling, blockDiv);
                }
            }
        }
    </script>

<div class="container">
    <h1>Создание документа</h1>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ document_form.as_p }}

        {{ block_formset.management_form }}
        {% for form in block_formset %}
            <div class="block-form">
                <h3>Блок {{ forloop.counter }}</h3>
                {{ form.block_type }}
                <div class="text-field hidden">
                    {{ form.content.label }}<br>
                    {{ form.content }}<br>
                </div>
                <div class="image-field hidden">
                    {{ form.image.label }}<br>
                    {{ form.image }}<br>
                </div>
                <div class="video-field hidden">
                    {{ form.video.label }}<br>
                    {{ form.video }}<br>
                </div>
                <button type="button" onclick="moveBlock(this.closest('.block-form'), 'up')">↑</button>
                <button type="button" onclick="moveBlock(this.closest('.block-form'), 'down')">↓</button>
            </div>
            <script>
                // Инициализация состояния полей при загрузке страницы
                document.addEventListener('DOMContentLoaded', function() {
                    const selectElement = document.querySelectorAll('select[name$=block_type]');
                    selectElement.forEach(select => {
                        toggleBlockFields(select);
                        select.addEventListener('change', function() {
                            toggleBlockFields(this);
                        });
                    });
                });
            </script>
        {% endfor %}

        <button class="btn btn-primary" type="submit">Сохранить</button>
        <a href="{% url 'documents' %}" class="btn btn-success">Вернуться</a>
    </form>
</div>-->
<!--<h1>Создание документа</h1>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div>
        <label for="id_title">Название документа:</label>
        {{ form.title }}
    </div>
    <h2>Блоки</h2>
    <div id="block-container">
        <div class="block">
            <select name="block_type" class="block-type">
                <option value="Текст">Текст</option>
                <option value="Изображение">Изображение</option>
                <option value="Видео">Видео</option>
            </select>
            <textarea name="content" placeholder="Введите текст"></textarea>
            <input type="file" name="image" accept="image/*" style="display: none;">
            <input type="file" name="video" accept="video/*" style="display: none;">
            <button type="button" class="remove-block">Удалить</button>
            <button type="button" class="move-up">Вверх</button>
            <button type="button" class="move-down">Вниз</button>
            <input type="hidden" name="block_order[]" value="0">
        </div>
    </div>
    <button type="button" id="add-block">Добавить блок</button>
    <button type="submit">Создать документ</button>
</form>

<script>
    // Функция для обновления видимости полей в зависимости от выбранного типа блока
    function updateBlockVisibility(block) {
        const blockType = block.querySelector('.block-type').value;
        const textarea = block.querySelector('textarea');
        const imageInput = block.querySelector('input[name="image"]');
        const videoInput = block.querySelector('input[name="video"]');

        if (blockType === 'Изображение') {
            textarea.style.display = 'none';
            imageInput.style.display = 'block';
            videoInput.style.display = 'none';
        } else if (blockType === 'Видео') {
            textarea.style.display = 'none';
            videoInput.style.display = 'block';
            imageInput.style.display = 'none';
        } else {
            textarea.style.display = 'block';
            imageInput.style.display = 'none';
            videoInput.style.display = 'none';
        }
    }

    // Функция для обновления порядка блоков
    function updateBlockOrder() {
        const blocks = document.querySelectorAll('.block');
        blocks.forEach((block, index) => {
            const orderInput = block.querySelector('input[name="block_order[]"]');
            orderInput.value = index; // Устанавливаем порядок
        });
    }

    // Функция для добавления обработчиков событий к блоку
    function addBlockEventListeners(block) {
        block.querySelector('.block-type').addEventListener('change', function() {
            updateBlockVisibility(block);
        });

        block.querySelector('.remove-block').addEventListener('click', function() {
            block.remove();
            updateBlockOrder(); // Обновляем порядок после удаления
        });

        block.querySelector('.move-up').addEventListener('click', function() {
            const previousBlock = block.previousElementSibling;
            if (previousBlock) {
                block.parentNode.insertBefore(block, previousBlock);
                updateBlockOrder(); // Обновляем порядок после перемещения
            }
        });

        block.querySelector('.move-down').addEventListener('click', function() {
            const nextBlock = block.nextElementSibling;
            if (nextBlock) {
                block.parentNode.insertBefore(nextBlock, block);
                updateBlockOrder(); // Обновляем порядок после перемещения
            }
        });
    }

    // Обработчик для добавления нового блока
    document.getElementById('add-block').addEventListener('click', function() {
        const blockContainer = document.getElementById('block-container');
        const newBlock = document.createElement('div');
        newBlock.classList.add('block');
        newBlock.innerHTML = `
            <select name="block_type" class="block-type">
                <option value="Текст">Текст</option>
                <option value="Изображение">Изображение</option>
                <option value="Видео">Видео</option>
            </select>
            <textarea name="content" placeholder="Введите текст"></textarea>
            <input type="file" name="image" accept="image/*" style="display: none;">
            <input type="file" name="video" accept="video/*" style="display: none;">
            <button type="button" class="remove-block">Удалить</button>
            <button type="button" class="move-up">Вверх</button>
            <button type="button" class="move-down">Вниз</button>
            <input type="hidden" name="block_order[]" value="0">
        `;
        blockContainer.appendChild(newBlock);

        // Обновляем видимость полей для нового блока
        updateBlockVisibility(newBlock);

        // Добавляем обработчики событий для нового блока
        addBlockEventListeners(newBlock);

        // Обновляем порядок блоков
        updateBlockOrder();
    });

    // Инициализация видимости полей и обработчиков событий для первого блока
    const initialBlock = document.querySelector('.block');
    updateBlockVisibility(initialBlock);
    addBlockEventListeners(initialBlock);
</script>-->
<h1>Создание документа</h1>
<form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ document_form.as_p }}
        <div id="block-container">
            <h2>Блоки</h2>
            <div class="block">
                <select name="block_type" class="block-type">
                    <option value="Текст">Текст</option>
                    <option value="Изображение">Изображение</option>
                    <option value="Видео">Видео</option>
                </select>
                <textarea name="content" placeholder="Введите текст"></textarea>
                <input type="file" name="image" accept="image/*" style="display: none;">
                <input type="file" name="video" accept="video/*" style="display: none;">
                <button type="button" class="remove-block">Удалить</button>
                <button type="button" class="move-up">Вверх</button>
                <button type="button" class="move-down">Вниз</button>
            </div>
        </div>
        <button type="button" id="add-block">Добавить блок</button>
        <button type="submit">Создать документ</button>
    </form>

    <script>
        document.getElementById('add-block').addEventListener('click', function() {
            const blockContainer = document.getElementById('block-container');
            const newBlock = document.createElement('div');
            newBlock.classList.add('block');
            newBlock.innerHTML = `
                <select name="block_type" class="block-type">
                    <option value="Текст">Текст</option>
                    <option value="Изображение">Изображение</option>
                    <option value="Видео">Видео</option>
                </select>
                <textarea name="content" placeholder="Введите текст"></textarea>
                <input type="file" name="image" accept="image/*" style="display: none;">
                <input type="file" name="video" accept="video/*" style="display: none;">
                <button type="button" class="remove-block">Удалить</button>
                <button type="button" class="move-up">Вверх</button>
                <button type="button" class="move-down">Вниз</button>
            `;
            blockContainer.appendChild(newBlock);
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-block')) {
                event.target.closest('.block').remove();
            }

            if (event.target.classList.contains('move-up')) {
                const block = event.target.closest('.block');
                if (block.previousElementSibling) {
                    block.parentNode.insertBefore(block, block.previousElementSibling);
                }
            }

            if (event.target.classList.contains('move-down')) {
                const block = event.target.closest('.block');
                if (block.nextElementSibling) {
                    block.parentNode.insertBefore(block.nextElementSibling, block);
                }
            }
        });

        document.addEventListener('change', function(event) {
            if (event.target.classList.contains('block-type')) {
                const block = event.target.closest('.block');
                const selectedValue = event.target.value;
                const textarea = block.querySelector('textarea');
                const imageInput = block.querySelector('input[type="file"][name="image"]');
                const videoInput = block.querySelector('input[type="file"][name="video"]');

                textarea.style.display = selectedValue === 'Текст' ? 'block' : 'none';
                imageInput.style.display = selectedValue === 'Изображение' ? 'block' : 'none';
                videoInput.style.display = selectedValue === 'Видео' ? 'block' : 'none';
            }
        });
    </script>

{% endblock %}
